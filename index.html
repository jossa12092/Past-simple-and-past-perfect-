<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Past Simple vs Present Perfect ‚Äî Gamified Canvas</title>
<style>
  :root{ --bg:#0f172a; --panel:#0f172af2; --ink:#f8fafc; --ink-dim:#e2e8f0; --accent:#22d3ee; --good:#22c55e; --bad:#ef4444; --muted:#a5b4fc; }
  html,body{height:100%;background:radial-gradient(1200px 600px at 70% 20%, #1f2937 0%, #0b1224 60%, #060914 100%);margin:0;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  .wrap{display:grid;grid-template-columns:minmax(250px,300px) 1fr;gap:12px;height:100%;padding:12px;box-sizing:border-box}
  .panel{background:var(--panel);backdrop-filter:blur(10px);border:1px solid #1f2937;border-radius:18px;box-shadow:0 10px 30px #0007;display:flex;flex-direction:column;min-height:0}
  .panel h1{font-size:20px;margin:14px 16px 8px;color:var(--ink)}
  .panel .sub{color:var(--ink-dim);font-size:12px;margin:0 16px 8px}
  .meta{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:0 12px 12px}
  .pill{background:#0b1224;border:1px solid #253048;border-radius:12px;padding:8px 10px;font-size:12px;text-align:center;color:var(--ink)}
  .btn{cursor:pointer;user-select:none;border:none;border-radius:12px;padding:10px 14px;background:linear-gradient(135deg,#0ea5e9,#22d3ee);color:#081018;font-weight:700;box-shadow:0 6px 18px #0ea5e955, inset 0 0 0 1px #ffffff30;transition:transform .04s ease}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn:active{transform:translateY(1px)}
  canvas{width:100%;height:100%;display:block;border-radius:18px}
  .stage{position:relative}
  .hud{position:absolute;inset:0;pointer-events:none}
  .toast{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);background:#0b1224cc;border:1px solid #1f2937;color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:600}
  .footer{padding:12px;border-top:1px dashed #1f2937}
  .progress{height:8px;background:#0b1224;border-radius:999px;overflow:hidden;border:1px solid #1f2937}
  .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#60a5fa)}
  .badge{font-size:11px;padding:6px 8px;border-radius:999px;background:#0b1224;border:1px solid #253048;color:var(--ink-dim)}

  /* FULL-SPACE QUESTION DOCK */
  .dock{position:absolute;inset:12px;display:grid;grid-template-columns:1fr;grid-auto-rows:minmax(0,1fr);gap:12px;pointer-events:auto}
  .card{background:#0b1224dd;border:1px solid #1f2937;border-radius:16px;padding:14px;display:flex;flex-direction:column;min-height:0;color:var(--ink)}
  .qtitle{font-weight:800;margin:0 0 8px 0;color:var(--ink)}
  .qgrid{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:12px;min-height:0}
  .options{display:grid;grid-template-columns:1fr;gap:10px;align-content:start}
  .choice{border:1px solid #253048;border-radius:12px;padding:12px;background:#0f172a;color:var(--ink);cursor:pointer}
  .choice.correct{outline:2px solid var(--good)}
  .choice.wrong{outline:2px solid var(--bad)}
  .explain{font-size:12px;color:var(--ink-dim);margin-top:6px}
  .timerWrap{position:absolute;left:12px;right:12px;top:12px;height:8px;border-radius:999px;background:#0b1224;border:1px solid #1f2937;overflow:hidden}
  .timerBar{height:100%;width:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee)}

  /* Selection-based Matching & Ordering (high-contrast) */
  .bank,.targets{background:#091126;border:1px dashed #2b3a57;border-radius:12px;padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-content:flex-start;min-height:110px}
  .selToken{padding:10px 12px;border-radius:10px;background:#0f1a33;border:1px solid #2b3a57;cursor:pointer;user-select:none;color:var(--ink);font-weight:600}
  .selToken.selected{outline:2px solid #7dd3fc}
  .catBtn{padding:10px 12px;border-radius:10px;background:#0f1a33;border:1px solid #2b3a57;color:var(--ink);cursor:pointer}
  .catBtn.selected{outline:2px solid #22d3ee}
  .posSlot{min-width:140px;min-height:42px;padding:10px;border-radius:10px;background:#0f1a33;border:1px dashed #334155;display:flex;align-items:center;justify-content:center;color:var(--ink)}
  .posSlot.filled{border-style:solid}
  .rowMatch{display:grid;grid-template-columns:1fr 220px;gap:8px;align-items:center}
  .rowMatch label{font-weight:700;color:var(--ink)}
  select.matchSel{appearance:none;background:#0f1a33;border:1px solid #2b3a57;color:var(--ink);padding:10px;border-radius:10px;font-weight:600}

  /* Writing full screen */
  #writingWrap{grid-template-columns:1fr;}
  .writePanel{display:flex;flex-direction:column;gap:10px;padding:12px;height:calc(100vh - 24px)}
  textarea{width:100%;flex:1;min-height:75vh;resize:none;background:#0f172a;color:var(--ink);border:1px solid #253048;border-radius:12px;padding:14px;font-size:15px;line-height:1.5}
  .topbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .hint{font-size:12px;color:var(--ink-dim)}

  @media (max-width: 980px){.wrap{grid-template-columns:1fr}.qgrid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <aside class="panel" id="left">
    <h1>Past Simple vs Present Perfect</h1>
    <p class="sub">Play, learn, and prove you can choose the right tense. Then write your travel story.</p>
    <div class="meta">
      <div class="pill">Level <b id="lvl">1</b>/5</div>
      <div class="pill">Hearts <b id="hearts">3</b> ‚ù§Ô∏è</div>
      <div class="pill">Score <b id="score">0</b></div>
    </div>
    <div style="padding:12px">
      <button class="btn" id="btnStart">Start / Reset</button>
      <div class="progress" style="margin-top:10px"><i id="progbar"></i></div>
      <div class="badge" id="tests">Self‚Äëcheck: running‚Ä¶</div>
      <div class="badge">Tip: <b>Past simple</b> ‚Üí finished time (yesterday, in 2021). <b>Present perfect</b> ‚Üí result/unfinished time (today, this week, ever, yet).</div>
    </div>
    <div class="footer">
      <div class="badge">‚úîÔ∏è Correct: <b id="ok">0</b> &nbsp; ‚úñÔ∏è Wrong: <b id="wrong">0</b> &nbsp; üî• Streak: <b id="streak">0</b></div>
    </div>
  </aside>

  <main class="panel stage" id="stage">
    <canvas id="game" aria-label="Gamified canvas"></canvas>
    <div class="hud">
      <div class="timerWrap"><div class="timerBar" id="timerBar"></div></div>
      <div class="dock" id="qpanel"></div>
      <div class="toast hidden" id="toast"></div>
    </div>
    <div class="footer">
      <div class="badge">Tasks done: <b id="done">0</b>/<b id="total">0</b> ‚Äî Accuracy: <b id="acc">0%</b></div>
    </div>
  </main>
</div>

<!-- Writing (full-screen style) -->
<div class="wrap" id="writingWrap" style="display:none">
  <main class="panel writePanel">
    <div class="topbar">
      <h1 style="margin:0">Final Writing Challenge</h1>
      <span class="badge">Writing time left: <b id="wtime">20:00</b></span>
      <span class="badge">Words: <b id="wcount">0</b></span>
      <span class="badge">Present perfect: <b id="ppCount">0</b></span>
      <span class="badge">Past simple: <b id="psCount">0</b></span>
    </div>
    <textarea id="essay" placeholder="Write your 150+ word travel story. Use past simple for finished times (last year, yesterday) and present perfect for experiences or results (I have visited‚Ä¶, We have already‚Ä¶)." spellcheck="true"></textarea>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="btnGrade">Grade my story</button>
      <span class="hint">No pasting allowed. Any paste ‚Üí <b style="color:var(--bad)">0.0/5.0</b>.</span>
    </div>
    <div id="result" class="badge" style="white-space:pre-wrap"></div>
  </main>
</div>

<script>
// Robust onReady
(function(onReady){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', onReady); } else { onReady(); } })(function(){
  // ===== Canvas engine =====
  const C = /** @type {HTMLCanvasElement} */(document.getElementById('game')); const ctx=C.getContext('2d');
  let W=0,H=0,anim=0,sparkles=[];
  function fit(){const dpr=Math.min(window.devicePixelRatio||1,2);const r=C.getBoundingClientRect();W=Math.floor(r.width*dpr);H=Math.floor((r.height||540)*dpr);C.width=W;C.height=H;ctx.setTransform(dpr,0,0,dpr,0,0)};window.addEventListener('resize',fit,{passive:true});fit();
  function rnd(a,b){return Math.random()*(b-a)+a}
  function bg(){const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,'#0f172a');g.addColorStop(1,'#020617');ctx.fillStyle=g;ctx.fillRect(0,0,W,H);ctx.globalAlpha=.25;ctx.fillStyle='#22d3ee';for(let i=0;i<3;i++){const y=(H/4)*(i+1)+Math.sin(perf.now/700+i)*18;ctx.beginPath();ctx.moveTo(-50,y);for(let x=-50;x<W+50;x+=20){const yy=y+Math.sin(x/120+perf.now/900+i)*12;ctx.lineTo(x,yy);}ctx.lineTo(W+50,H+50);ctx.lineTo(-50,H+50);ctx.closePath();ctx.fill();}ctx.globalAlpha=1}
  function fx(){ctx.fillStyle='#22d3ee';sparkles=sparkles.filter(p=>p.a>0.02);for(const p of sparkles){ctx.globalAlpha=p.a;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();p.y+=0.2;p.a*=0.985}ctx.globalAlpha=1}
  const perf={now:0};function loop(t){perf.now=t;bg();fx();anim=requestAnimationFrame(loop)};anim=requestAnimationFrame(loop);
  function sparkle(){for(let i=0;i<6;i++)sparkles.push({x:rnd(0,W),y:rnd(0,H/2),r:rnd(1,3),a:1})}

  // ===== Game bank =====
  const bank=[
    {level:1,type:'mc',prompt:'Choose the correct sentence.',options:[
      {t:'I went to the zoo yesterday.', ok:true, why:'"yesterday" ‚Üí finished time ‚Üí past simple.'},
      {t:'I have been to the zoo yesterday.', ok:false, why:'Present perfect does not go with finished time words.'},
      {t:'I have went to the zoo yesterday.', ok:false, why:'"have went" is incorrect; use "went" or "been".'}
    ]},
    {level:1,type:'mc',prompt:'Choose the correct sentence.',options:[
      {t:'When you have eaten your dinner, you can go and play.', ok:true, why:'Condition completed before next action ‚Üí present perfect.'},
      {t:'When you ate your tea, you can go and play.', ok:false, why:'Wrong tense mix.'},
      {t:'When you eat your dinner, you could went to play.', ok:false, why:'Verb form wrong.'}
    ]},
    // Matching (dropdowns per row)
    {level:2,type:'match',prompt:'Select the correct tense for each expression.',pairs:[
      ['yesterday','Past Simple'],['in 2019','Past Simple'],['this week','Present Perfect'],['ever','Present Perfect'],['last night','Past Simple'],['already','Present Perfect']
    ],categories:['Past Simple','Present Perfect']},
    // Ordering (select positions)
    {level:3,type:'order',prompt:'Select the correct position for each part.',items:['I have finished','my homework,','so','I can play now.'],ok:['I have finished','my homework,','so','I can play now.']},
    {level:3,type:'mc',prompt:'Choose the correct past participle (V3). My hair has really __ recently.',options:[
      {t:'grown', ok:true, why:'grow ‚Äî grew ‚Äî grown'},
      {t:'grew', ok:false, why:'Past simple, not V3.'},
      {t:'growed', ok:false, why:'Incorrect form.'}
    ]},
    {level:4,type:'match',prompt:'Select the tense for each verb form.',pairs:[
      ['went','Past Simple'],['was/were','Past Simple'],['has gone','Present Perfect'],['have visited','Present Perfect'],['slept','Past Simple'],['has taken','Present Perfect']
    ],categories:['Past Simple','Present Perfect']},
    {level:5,type:'order',prompt:'Select positions to describe a finished time.',items:['Last year,','I','visited','Cusco.'],ok:['Last year,','I','visited','Cusco.']}
  ];

  function groupByLevel(){const levels=[1,2,3,4,5];let out=[];for(const L of levels){let arr=bank.filter(x=>x.level===L);out=out.concat(arr)}return out}

  // ===== Game state =====
  let deck=groupByLevel(); let ptr=0,hearts=3,score=0,ok=0,wrong=0,streak=0; let timeLeftMs=60000,timerId=null; // 60s per task
  const el=(id)=>document.getElementById(id); const qpanel=el('qpanel'); const toast=el('toast'); const timerBar=el('timerBar');
  function showToast(msg,color){toast.textContent=msg;toast.classList.remove('hidden');toast.style.color='var(--ink)';toast.style.background='#0b1224cc';toast.style.outline=(color==='good'? '2px solid var(--good)': color==='bad'? '2px solid var(--bad)':'none'); setTimeout(()=>toast.classList.add('hidden'),1200)}
  function updateHUD(){el('lvl').textContent=Math.min(5, deck[ptr]?deck[ptr].level:5); el('hearts').textContent=hearts; el('score').textContent=score; el('ok').textContent=ok; el('wrong').textContent=wrong; el('streak').textContent=streak; el('done').textContent=ptr; el('total').textContent=deck.length; const p=Math.round((ptr/deck.length)*100); el('acc').textContent=(ok+wrong? Math.round(ok*100/(ok+wrong)):0)+'%'; el('progbar').style.width=p+'%'}
  function startTimer(){stopTimer(); timeLeftMs=60000; tick(); timerId=setInterval(tick,50)} function stopTimer(){if(timerId){clearInterval(timerId);timerId=null}} function tick(){timeLeftMs-=50; if(timeLeftMs<0) timeLeftMs=0; timerBar.style.width=(timeLeftMs/60000*100)+'%'; if(timeLeftMs===0){stopTimer(); timesUp()}}
  function timesUp(){hearts--; wrong++; streak=0; showToast("Time's up! ‚àí1 ‚ù§Ô∏è",'bad'); if(hearts<=0){gameOver()} else {ptr++; updateHUD(); renderQuestion()}}

  // rotate correct answer among indices 0..n-1 even after shuffle
  let __rotIdx=0;

  function renderQuestion(){
    qpanel.innerHTML='';
    const item=deck[ptr];
    if(!item){ document.querySelector('.wrap').style.display='none'; document.getElementById('writingWrap').style.display='grid'; startWritingTimer(); cancelAnimationFrame(anim); sparkle(); return; }
    const card=document.createElement('div'); card.className='card'; qpanel.appendChild(card);
    const title=document.createElement('div'); title.className='qtitle'; title.textContent=`Level ${item.level}`; card.appendChild(title);
    const p=document.createElement('div'); p.style.marginBottom='8px'; p.innerHTML=`<b>${item.prompt}</b>`; card.appendChild(p);
    const area=document.createElement('div'); area.className='qgrid'; card.appendChild(area);

    if(item.type==='mc'){
      let opts=[...item.options];
      if(opts.length<3){ const template=opts[0]?.t||''; let decoy=template.replace(/have\s+([a-z]+)/i,'has $1'); if(decoy===template) decoy = template.replace(/went/,'have went'); opts.push({t:decoy, ok:false, why:'Distractor ‚Äî wrong agreement or form.'}); }
      let shuffled=opts.sort(()=>Math.random()-0.5);
      const tgt=(__rotIdx++)%shuffled.length; const cidx=shuffled.findIndex(o=>o.ok); if(cidx>-1 && tgt!==cidx){const [co]=shuffled.splice(cidx,1); shuffled.splice(tgt,0,co);}
      const right=document.createElement('div'); right.className='options'; area.appendChild(document.createElement('div')); area.appendChild(right);
      shuffled.forEach(o=>{const b=document.createElement('div'); b.className='choice'; b.innerHTML=`<div>${o.t}</div><div class="explain"></div>`; right.appendChild(b); b.addEventListener('click',()=>{
        right.querySelectorAll('.choice').forEach(e=>e.style.pointerEvents='none'); stopTimer();
        if(o.ok){ b.classList.add('correct'); score+=10; ok++; streak++; sparkle(); b.querySelector('.explain').textContent=o.why; showToast('Correct! +10','good'); setTimeout(()=>{ptr++; updateHUD(); renderQuestion()},600); }
        else { b.classList.add('wrong'); wrong++; streak=0; hearts--; score=Math.max(0,score-2); b.querySelector('.explain').textContent=o.why; showToast('Incorrect. ‚àí2','bad'); setTimeout(()=>{ if(hearts<=0){gameOver()} else {ptr++; updateHUD(); renderQuestion()} },600); }
      })});
      startTimer();
    }
    else if(item.type==='match'){
      // Dropdown per row: each expression gets a select with all categories
      const left=document.createElement('div'); left.className='bank'; left.style.flexDirection='column'; left.style.width='100%'; left.style.gap='10px';
      area.appendChild(left); area.appendChild(document.createElement('div'));
      const cats=item.categories || [...new Set(item.pairs.map(p=>p[1]))];
      const rows=item.pairs.map(([expr,correct])=>{
        const row=document.createElement('div'); row.className='rowMatch';
        const lab=document.createElement('label'); lab.textContent=expr; lab.setAttribute('aria-label',expr);
        const sel=document.createElement('select'); sel.className='matchSel'; sel.innerHTML='<option value="">Choose‚Ä¶</option>'+cats.map(c=>`<option>${c}</option>`).join('');
        row.appendChild(lab); row.appendChild(sel); left.appendChild(row);
        return {expr, correct, sel};
      });
      const check=document.createElement('button'); check.className='btn'; check.textContent='Check answers'; check.disabled=true; card.appendChild(check);
      function canCheck(){check.disabled = rows.some(r=>!r.sel.value)}
      left.addEventListener('change',canCheck); canCheck();
      check.addEventListener('click',()=>{
        stopTimer();
        const okAll = rows.every(r=>r.sel.value===r.correct);
        rows.forEach(r=>{r.sel.style.outline = (r.sel.value===r.correct? '2px solid var(--good)': '2px solid var(--bad)')});
        if(okAll){ score+=10; ok++; streak++; sparkle(); showToast('Great matching! +10','good'); }
        else { wrong++; hearts--; streak=0; score=Math.max(0,score-2); showToast('Not quite. ‚àí2','bad'); }
        setTimeout(()=>{ if(hearts<=0){gameOver()} else {ptr++; updateHUD(); renderQuestion()} },800);
      });
      startTimer();
    }
    else if(item.type==='order'){
      // Selection-based ordering: each part has a select to choose its final position
      const left=document.createElement('div'); left.className='bank'; left.style.flexDirection='column'; left.style.width='100%'; left.style.gap='10px'; area.appendChild(left); area.appendChild(document.createElement('div'));
      const n=item.items.length; const positions=Array.from({length:n},(_,i)=>String(i+1));
      const rows=item.items.map((txt,i)=>{
        const row=document.createElement('div'); row.className='rowMatch';
        const lab=document.createElement('label'); lab.textContent=txt;
        const sel=document.createElement('select'); sel.className='matchSel'; sel.innerHTML='<option value="">Position‚Ä¶</option>'+positions.map(p=>`<option>${p}</option>`).join('');
        row.appendChild(lab); row.appendChild(sel); left.appendChild(row);
        return {txt, sel};
      });
      const check=document.createElement('button'); check.className='btn'; check.textContent='Check order'; check.disabled=true; card.appendChild(check);
      function canCheck(){
        const allFilled = rows.every(r=>r.sel.value);
        const unique = new Set(rows.map(r=>r.sel.value)).size===rows.length; // no repeated positions
        check.disabled = !(allFilled && unique);
      }
      left.addEventListener('change',canCheck); canCheck();
      check.addEventListener('click',()=>{
        stopTimer();
        // Build array by selected position index
        const placed = Array(rows.length);
        rows.forEach(r=>{ const idx=parseInt(r.sel.value,10)-1; placed[idx]=r.txt; });
        const okOrder = placed.join('|')===item.ok.join('|');
        rows.forEach(r=>{ r.sel.style.outline='2px solid #334155'; });
        if(okOrder){ score+=10; ok++; streak++; sparkle(); showToast('Nice order! +10','good'); }
        else { wrong++; hearts--; streak=0; score=Math.max(0,score-2); showToast('Order not correct. ‚àí2','bad'); }
        setTimeout(()=>{ if(hearts<=0){gameOver()} else {ptr++; updateHUD(); renderQuestion()} },800);
      });
      startTimer();
    }
    updateHUD();
  }

  function gameOver(){stopTimer(); qpanel.innerHTML=`<div class="card" style="text-align:center"><div class="qtitle">Game over</div>Your score: <b>${score}</b><br><br><button class="btn" id="btnRetry">Retry</button></div>`; const br=document.getElementById('btnRetry'); if(br) br.addEventListener('click',start)}
  function start(){deck=groupByLevel(); ptr=0; hearts=3; score=0; ok=0; wrong=0; streak=0; updateHUD(); renderQuestion()}

  const btnStart=document.getElementById('btnStart'); if(btnStart) btnStart.addEventListener('click',start); start();

  // ===== Writing (20 minutes, full-screen) =====
  const essay=document.getElementById('essay'); const wcount=document.getElementById('wcount'); const res=document.getElementById('result'); const ppCount=document.getElementById('ppCount'); const psCount=document.getElementById('psCount'); let pasted=false; let wTimer=null; let wMs=20*60*1000;
  function wordCount(s){return (s.trim().match(/\b[\w'‚Äô-]+\b/g)||[]).length}
  function countPresentPerfect(s){const v3=/(been|gone|done|had|taken|grown|come|forgotten|blown|begun|drawn|moved|spoken|slept|lost|arrived|visited|seen|tried|studied|played|worked|watched|travelled|traveled)/i; const re=/\b(have|has)\s+(?:\w+ly\s+)?(\w+)\b/gi; let m,c=0; while((m=re.exec(s))){ if(v3.test(m[2])) c++; } return c}
  function countPastSimple(s){const pastList=/(went|was|were|got|moved|met|spoke|had|slept|lost|arrived|visited|saw|tried|studied|played|worked|watched|travelled|traveled|came|forgot|blew|began|drew|stayed|walked|looked)/gi; return (s.match(pastList)||[]).length}
  function updateStats(){const txt=essay?.value||''; if(!essay) return; wcount.textContent=String(wordCount(txt)); ppCount.textContent=String(countPresentPerfect(txt)); psCount.textContent=String(countPastSimple(txt))}
  if(essay){
    essay.addEventListener('input',updateStats);
    essay.addEventListener('paste',e=>{e.preventDefault(); pasted=true; showToast('Paste detected ‚Äî score will be 0.0','bad')});
    essay.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&(e.key.toLowerCase()==='v')){pasted=true; showToast('Paste detected ‚Äî score will be 0.0','bad'); e.preventDefault()}})
  }
  function startWritingTimer(){
    const wtime=document.getElementById('wtime'); if(!wtime || !essay) return;
    if(wTimer) clearInterval(wTimer); wMs=20*60*1000; essay.readOnly=false; 
    function wt(){wMs-=1000; if(wMs<0) wMs=0; const m=String(Math.floor(wMs/60000)).padStart(2,'0'); const s=String(Math.floor((wMs%60000)/1000)).padStart(2,'0'); wtime.textContent=`${m}:${s}`; if(wMs===0){clearInterval(wTimer); essay.readOnly=true; showToast('Writing time finished','bad')}}
    wtime.textContent='20:00'; wTimer=setInterval(wt,1000)
  }

  // Grading via delegation
  document.addEventListener('click', (e)=>{
    const g = e.target && (e.target.id==='btnGrade' ? e.target : (e.target.closest && e.target.closest('#btnGrade')));
    if(!g) return;
    if(!essay) return;
    const txt=essay.value.trim(); updateStats(); if(!txt){res.textContent='Please write your story first.'; return;} const wc=wordCount(txt);
    let grammar=2.0; const iErrors=(txt.match(/\bi\b/g)||[]).length; if(iErrors>0) grammar-=Math.min(1.0,iErrors*0.25); const typos=(txt.match(/\b([a-z]{1,2})\s+\1\b/gi)||[]).length>2; if(typos) grammar-=0.4;
    let coherence=1.0; const conn=(txt.match(/(and|but|because|so|then|after|before)/gi)||[]).length; if(conn<3) coherence-=0.4; if(conn<2) coherence-=0.2;
    const pp=countPresentPerfect(txt); const ps=countPastSimple(txt); let tense=2.0; if(pp<3) tense-=(3-pp)*0.4; if(ps<5) tense-=(5-ps)*0.2;
    if(wc<150){ const lack=Math.min(150-wc,100); const p=(lack/100); grammar-=p*0.5; coherence-=p*0.3 }
    grammar=Math.max(0,Math.min(2.0,grammar)); coherence=Math.max(0,Math.min(1.0,coherence)); tense=Math.max(0,Math.min(2.0,tense));
    let total=parseFloat((grammar+coherence+tense).toFixed(1)); if(pasted) total=0.0;
    let fb=`Score: ${total.toFixed(1)}/5.0\nGrammar: ${grammar.toFixed(1)}/2.0\nCoherence: ${coherence.toFixed(1)}/1.0\nTense Use: ${tense.toFixed(1)}/2.0 (PP=${pp}, PS=${ps})`;
    if(wMs<=0) fb+="\nTime is over. Your text was locked at 20 minutes."; if(pasted) fb+="\nPaste detected ‚Üí automatic 0.0"; res.textContent=fb;
  });

  // ===== Self‚Äëtests =====
  (function runTests(){
    const results=[]; let pass=0,fail=0;
    try{startTimer(); if(timeLeftMs===60000){pass++;results.push('Timer 60s ‚úì')} else {fail++;results.push('Timer !=60s ‚úó')}}catch(e){fail++;results.push('Timer threw ‚úó')}
    try{const rot=[0,1,2].map(()=>{__rotIdx=0; const opts=[{ok:true},{ok:false},{ok:false}]; let s=opts.sort(()=>Math.random()-0.5); const tgt=(__rotIdx++)%s.length; const cidx=s.findIndex(o=>o.ok); if(cidx>-1&&tgt!==cidx){const [co]=s.splice(cidx,1); s.splice(tgt,0,co);} return s.findIndex(o=>o.ok)}); if(new Set(rot).size>=2){pass++;results.push('Rotation varies ‚úì')} else {fail++;results.push('Rotation fixed ‚úó')}}catch(e){fail++;results.push('Rotation threw ‚úó')}
    try{const a=countPresentPerfect('I have visited Rome. She has gone home.'); if(a>=2){pass++;results.push('PP counter ‚úì')} else {fail++;results.push('PP counter low ‚úó')}}catch(e){fail++;results.push('PP counter threw ‚úó')}
    try{const b=countPastSimple('I went to Bogota and stayed two nights.'); if(b>=2){pass++;results.push('PS counter ‚úì')} else {fail++;results.push('PS counter low ‚úó')}}catch(e){fail++;results.push('PS counter threw ‚úó')}
    try{let prev=ptr; let idx=deck.findIndex(x=>x.type==='match'); if(idx>=0){ ptr=idx; renderQuestion(); const okUI=!!document.querySelector('select.matchSel'); if(okUI){pass++;results.push('Match dropdown UI ‚úì')} else {fail++;results.push('Match UI missing ‚úó')} ptr=prev; renderQuestion(); }}catch(e){fail++;results.push('Match UI test threw ‚úó')}
    try{let prev=ptr; let idx=deck.findIndex(x=>x.type==='order'); if(idx>=0){ ptr=idx; renderQuestion(); const okUI=!!document.querySelector('select.matchSel'); if(okUI){pass++;results.push('Order dropdown UI ‚úì')} else {fail++;results.push('Order UI missing ‚úó')} ptr=prev; renderQuestion(); }}catch(e){fail++;results.push('Order UI test threw ‚úó')}
    document.getElementById('tests').textContent=`Self‚Äëcheck: ${pass} passed, ${fail} failed ‚Äî ${results.join(' | ')}`;
  })();
});
</script>
</body>
</html>
